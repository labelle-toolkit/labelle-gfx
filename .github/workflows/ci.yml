name: CI - Build and Screenshot Examples

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Zig
        uses: mlugg/setup-zig@v2
        with:
          version: 0.15.2

      - name: Install dependencies for raylib and sokol
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgl1-mesa-dev \
            libx11-dev \
            libxcursor-dev \
            libxrandr-dev \
            libxinerama-dev \
            libxi-dev \
            libxext-dev \
            libxfixes-dev \
            libwayland-dev \
            libxkbcommon-dev \
            libasound2-dev \
            xvfb

      - name: Build library
        run: zig build

      - name: Run zspec tests
        id: tests
        shell: bash
        run: |
          echo "::group::ðŸ§ª Running zspec tests"
          # Run tests and capture output
          set +e
          zig build test 2>&1 | tee test_output.txt
          TEST_EXIT_CODE=${PIPESTATUS[0]}
          set -e
          echo "::endgroup::"

          # Parse test results for summary
          PASSED=$(grep -oE '[0-9]+ of [0-9]+ tests passed' test_output.txt | grep -oE '^[0-9]+' || echo "0")
          TOTAL=$(grep -oE '[0-9]+ of [0-9]+ tests passed' test_output.txt | sed 's/.* of \([0-9]*\) tests.*/\1/' || echo "0")

          # Export for badge
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          if [ "$TEST_EXIT_CODE" -eq 0 ]; then
            echo "status=passing" >> $GITHUB_OUTPUT
          else
            echo "status=failing" >> $GITHUB_OUTPUT
          fi

          # Create a summary in the GitHub Actions UI
          echo "## ðŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "$TEST_EXIT_CODE" -eq 0 ]; then
            echo "âœ… **All $PASSED of $TOTAL tests passed!**" >> $GITHUB_STEP_SUMMARY
          else
            FAILED_COUNT=$((TOTAL - PASSED))
            echo "âŒ **Tests failed: $PASSED/$TOTAL passed ($FAILED_COUNT failed)**" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<details><summary>Test Output</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat test_output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY

          exit $TEST_EXIT_CODE

      - name: Run examples and capture screenshots
        run: |
          # Start virtual framebuffer for headless rendering
          Xvfb :99 -screen 0 1024x768x24 &
          export DISPLAY=:99
          sleep 2

          # Track failures
          FAILED=0

          # Run each example with CI_TEST mode - fail on any error
          echo "Running example 01..."
          if ! CI_TEST=1 zig build run-01_basic_sprite; then
            echo "::error::Example 01 failed to run"
            FAILED=1
          fi

          echo "Running example 02..."
          if ! CI_TEST=1 zig build run-02_animation; then
            echo "::error::Example 02 failed to run"
            FAILED=1
          fi

          echo "Running example 03..."
          if ! CI_TEST=1 zig build run-03_sprite_atlas; then
            echo "::error::Example 03 failed to run"
            FAILED=1
          fi

          echo "Running example 04..."
          if ! CI_TEST=1 zig build run-04_camera; then
            echo "::error::Example 04 failed to run"
            FAILED=1
          fi

          echo "Running example 05..."
          if ! CI_TEST=1 zig build run-05_ecs_rendering; then
            echo "::error::Example 05 failed to run"
            FAILED=1
          fi

          echo "Running example 06..."
          if ! CI_TEST=1 zig build run-06_effects; then
            echo "::error::Example 06 failed to run"
            FAILED=1
          fi

          echo "Running example 07..."
          if ! CI_TEST=1 zig build run-07_with_fixtures; then
            echo "::error::Example 07 failed to run"
            FAILED=1
          fi

          echo "Running example 08..."
          if ! CI_TEST=1 zig build run-08_nested_animations; then
            echo "::error::Example 08 failed to run"
            FAILED=1
          fi

          # List generated screenshots
          echo "Generated screenshots:"
          ls -la screenshot_*.png || echo "No screenshots found"

          # Verify all required screenshots exist
          REQUIRED_SCREENSHOTS="screenshot_01.png screenshot_02.png screenshot_03.png screenshot_04.png screenshot_05.png screenshot_06.png screenshot_07.png screenshot_08.png"
          for screenshot in $REQUIRED_SCREENSHOTS; do
            if [ ! -f "$screenshot" ]; then
              echo "::error::Missing required screenshot: $screenshot"
              FAILED=1
            fi
          done

          # Exit with failure if any screenshot is missing or example failed
          if [ $FAILED -eq 1 ]; then
            echo "::error::One or more screenshots could not be generated"
            exit 1
          fi

          echo "All screenshots generated successfully!"

      - name: Create test badge JSON
        if: github.ref == 'refs/heads/main'
        run: |
          PASSED=${{ steps.tests.outputs.passed }}
          TOTAL=${{ steps.tests.outputs.total }}
          STATUS=${{ steps.tests.outputs.status }}

          if [ "$STATUS" = "passing" ]; then
            COLOR="brightgreen"
          else
            COLOR="red"
          fi

          echo "{\"schemaVersion\":1,\"label\":\"tests\",\"message\":\"${PASSED}/${TOTAL} passed\",\"color\":\"${COLOR}\"}" > test-badge.json
          cat test-badge.json

      - name: Update test badge gist
        if: github.ref == 'refs/heads/main'
        uses: exuanbo/actions-deploy-gist@v1
        with:
          token: ${{ secrets.GIST_TOKEN }}
          gist_id: ${{ vars.TEST_BADGE_GIST_ID }}
          file_path: test-badge.json
          file_type: text

      - name: Upload screenshots as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: example-screenshots
          path: screenshot_*.png
          if-no-files-found: error

  # Post screenshots to PR comment
  post-screenshots:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: write

    steps:
      - name: Download screenshots
        uses: actions/download-artifact@v4
        with:
          name: example-screenshots
          path: screenshots

      - name: Create PR comment with screenshot status
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const screenshotsDir = 'screenshots';
            const examples = [
              { file: 'screenshot_01.png', name: '01 - Basic Sprite' },
              { file: 'screenshot_02.png', name: '02 - Animation' },
              { file: 'screenshot_03.png', name: '03 - Sprite Atlas' },
              { file: 'screenshot_04.png', name: '04 - Camera' },
              { file: 'screenshot_05.png', name: '05 - ECS Rendering' },
              { file: 'screenshot_06.png', name: '06 - Effects' },
              { file: 'screenshot_07.png', name: '07 - TexturePacker Fixtures' },
              { file: 'screenshot_08.png', name: '08 - Nested Animation Paths' },
            ];

            let comment = '## ðŸ“¸ Example Screenshots\n\n';
            comment += 'Visual verification of all examples from this PR:\n\n';

            let allFound = true;
            let foundCount = 0;

            // Check each screenshot exists
            comment += '| Example | Status |\n';
            comment += '|---------|--------|\n';

            for (const example of examples) {
              const filePath = path.join(screenshotsDir, example.file);
              if (fs.existsSync(filePath)) {
                comment += `| ${example.name} | âœ… Captured |\n`;
                foundCount++;
              } else {
                comment += `| ${example.name} | âŒ Missing |\n`;
                allFound = false;
              }
            }

            comment += '\n';

            if (allFound) {
              comment += `âœ… **All ${foundCount} screenshots generated successfully!**\n\n`;
            } else {
              comment += `âš ï¸ **${foundCount}/${examples.length} screenshots generated.** Some are missing - check the workflow logs.\n\n`;
            }

            comment += `ðŸ“¦ **[Download screenshots](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})**\n\n`;
            comment += '_Generated by CI workflow_';

            // Find existing comment or create new one
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('## ðŸ“¸ Example Screenshots')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment,
              });
              console.log('Updated existing PR comment');
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment,
              });
              console.log('Created new PR comment');
            }
