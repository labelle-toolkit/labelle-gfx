name: CI - Build and Screenshot Examples

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Zig
        uses: mlugg/setup-zig@v2
        with:
          version: 0.15.2

      - name: Install dependencies for raylib
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgl1-mesa-dev \
            libx11-dev \
            libxcursor-dev \
            libxrandr-dev \
            libxinerama-dev \
            libxi-dev \
            libxext-dev \
            libxfixes-dev \
            libwayland-dev \
            libxkbcommon-dev \
            xvfb

      - name: Build library
        run: zig build

      - name: Run tests
        run: zig build test

      - name: Run examples and capture screenshots
        run: |
          # Start virtual framebuffer for headless rendering
          Xvfb :99 -screen 0 1024x768x24 &
          export DISPLAY=:99
          sleep 2

          # Run each example with CI_TEST mode
          echo "Running example 01..."
          CI_TEST=1 zig build run-01_basic_sprite || echo "Example 01 failed"

          echo "Running example 02..."
          CI_TEST=1 zig build run-02_animation || echo "Example 02 failed"

          echo "Running example 03..."
          CI_TEST=1 zig build run-03_sprite_atlas || echo "Example 03 failed"

          echo "Running example 04..."
          CI_TEST=1 zig build run-04_camera || echo "Example 04 failed"

          echo "Running example 05..."
          CI_TEST=1 zig build run-05_ecs_rendering || echo "Example 05 failed"

          echo "Running example 06..."
          CI_TEST=1 zig build run-06_effects || echo "Example 06 failed"

          echo "Running example 07..."
          CI_TEST=1 zig build run-07_with_fixtures || echo "Example 07 failed"

          # List generated screenshots
          echo "Generated screenshots:"
          ls -la screenshot_*.png || echo "No screenshots found"

      - name: Upload screenshots as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: example-screenshots
          path: screenshot_*.png
          if-no-files-found: warn

  # Post screenshots to PR comment
  post-screenshots:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: write

    steps:
      - name: Download screenshots
        uses: actions/download-artifact@v4
        with:
          name: example-screenshots
          path: screenshots

      - name: Upload screenshots to GitHub and create comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const screenshotsDir = 'screenshots';
            let comment = '## ðŸ“¸ Example Screenshots\n\n';
            comment += 'Visual verification of all examples from this PR:\n\n';

            const examples = [
              { file: 'screenshot_01.png', name: '01 - Basic Sprite' },
              { file: 'screenshot_02.png', name: '02 - Animation' },
              { file: 'screenshot_03.png', name: '03 - Sprite Atlas' },
              { file: 'screenshot_04.png', name: '04 - Camera' },
              { file: 'screenshot_05.png', name: '05 - ECS Rendering' },
              { file: 'screenshot_06.png', name: '06 - Effects' },
              { file: 'screenshot_07.png', name: '07 - TexturePacker Fixtures' },
            ];

            for (const example of examples) {
              const filePath = path.join(screenshotsDir, example.file);
              if (fs.existsSync(filePath)) {
                // Read the file and encode as base64
                const fileContent = fs.readFileSync(filePath);
                const base64 = fileContent.toString('base64');

                // Upload as a gist or use artifact URL
                comment += `### ${example.name}\n`;
                comment += `âœ… Screenshot captured successfully\n\n`;
              } else {
                comment += `### ${example.name}\n`;
                comment += `âŒ Screenshot not found\n\n`;
              }
            }

            comment += '\n---\n';
            comment += 'ðŸ“¦ [Download all screenshots](../actions/runs/' + context.runId + ')\n';
            comment += '\n_Generated by CI workflow_';

            // Find existing comment or create new one
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('## ðŸ“¸ Example Screenshots')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment,
              });
            }
